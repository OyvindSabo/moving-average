<script>
  class Store {
    // @containerId: string
    constructor(containerId) {
      this.state = {
        days: 30,
        cryptocurrencyId: 'bitcoin',
        vsCurrencyId: 'eur',
        priceHistory: [],
      };

      // Bind actions to reducers
      window.addEventListener('SET_PRICE_HISTORY', ({ detail }) => {
        this.state = this.onSetPriceHistory(this.state, detail);
        this.render();
      });
      window.addEventListener('SET_CRYPTOCURRENCY', ({ detail }) => {
        this.state = this.onSetCryptocurrency(this.state, detail);
        this.afterSetCryptocurrency(this.state);
        this.render();
      });
      window.addEventListener('SET_VS_CURRENCY', ({ detail }) => {
        this.state = this.onSetVsCurrency(this.state, detail);
        this.render();
      });
      this.afterSetCryptocurrency(this.state);
    }

    // Reducers
    onSetPriceHistory(previousState, detail) {
      return detail.priceHistory
        ? { ...previousState, priceHistory: detail.priceHistory }
        : previousState;
    }
    onSetCryptocurrency(previousState, detail) {
      return detail.cryptocurrencyId
        ? { ...previousState, cryptocurrencyId: detail.cryptocurrencyId }
        : previousState;
    }
    onSetVsCurrency(previousState, detail) {
      return detail.vsCurrencyId
        ? { ...previousState, vsCurrencyId: detail.vsCurrencyId }
        : previousState;
    }

    // Epics
    async afterSetCryptocurrency(state) {
      return fetch(
        `https://api.coingecko.com/api/v3/coins/${
          state.cryptocurrencyId
        }/market_chart?vs_currency=${state.vsCurrencyId}&days=${Math.max(
          state.days,
          91
        )}`
      )
        .then(res =>
          res.json().then(res => {
            const priceHistory = res.prices;
            window.dispatchEvent(
              new CustomEvent('SET_PRICE_HISTORY', { detail: { priceHistory } })
            );
          })
        )
        .catch(error => {
          console.log('error: ', error);
        });
    }
    render() {
      console.log('this.state.priceHistory: ', this.state.priceHistory);
      document.getElementById(
        'current-price'
      ).innerHTML = this.state.priceHistory[
        this.state.priceHistory.length - 1
      ][1];
    }
  }
</script>

<div id="app-container">
  <span style="display:inline-block;width:100px;">Cryptocurrency</span>
  <select id="cryptocurrency-select">
    <option value="bitcoin">Bitcoin</option>
    <option value="ethereum">Ethereum</option>
    <option value="ripple">XRP</option>
    <option value="tether">Tether</option>
    <option value="bitcoin-cash">Bitcoin Cash</option>
    <!--TODO: Add the rest of the currencies from here: https://api.coingecko.com/api/v3/coins--> </select
  ><br />
  <span style="display:inline-block;width:100px;">vs. currency</span>
  <select id="vs-currency-select">
    <option value="usd">United States dollar</option>
    <option value="eur">Euro</option>
    <option value="jpy">Japanese yen</option>
    <option value="gbp">Pound sterling</option>
    <!--TODO: Add the rest of the currencies from here: https://api.coingecko.com/api/v3/coins--> </select
  ><br />
  <span style="display:inline-block;width:100px;">Current price: </span>
  <span id="current-price"></span>
</div>

<!--Add change listeners to HTML-->
<script>
  const cryptocurrencySelect = document.getElementById('cryptocurrency-select');
  cryptocurrencySelect.addEventListener('change', () => {
    const cryptocurrencyId = cryptocurrencySelect.value;
    window.dispatchEvent(
      new CustomEvent('SET_CRYPTOCURRENCY', { detail: { cryptocurrencyId } })
    );
  });

  const vsCurrencySelect = document.getElementById('vs-currency-select');
  vsCurrencySelect.addEventListener('change', () => {
    const vsCurrencySelectId = vsCurrencySelect.value;
    window.dispatchEvent(
      new CustomEvent('SET_VS_CURRENCY', { detail: { vsCurrencyId } })
    );
  });
</script>
<script>
  const store = new Store('app-container');
</script>
