<style>
  .lds-ellipsis {
    display: inline-block;
    position: absolute;
    width: 200px;
    height: 20px;
  }
  .lds-ellipsis div {
    position: absolute;
    top: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #fff;
    animation-timing-function: cubic-bezier(0, 1, 1, 0);
  }
  .lds-ellipsis div:nth-child(1) {
    background: #2c3e50;
    left: 5px;
    animation: lds-ellipsis1 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(2) {
    background: #2c3e50;
    left: 5px;
    animation: lds-ellipsis2 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(3) {
    background: #2c3e50;
    left: 30px;
    animation: lds-ellipsis2 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(4) {
    background: #2c3e50;
    left: 55px;
    animation: lds-ellipsis3 0.6s infinite;
  }
  @keyframes lds-ellipsis1 {
    0% {
      transform: scale(0);
    }
    100% {
      transform: scale(1);
    }
  }
  @keyframes lds-ellipsis3 {
    0% {
      transform: scale(1);
    }
    100% {
      transform: scale(0);
    }
  }
  @keyframes lds-ellipsis2 {
    0% {
      transform: translate(0, 0);
    }
    100% {
      transform: translate(25px, 0);
    }
  }
</style>

<style>
  .root-style {
    text-align: center;
  }
  .column-style {
    display: inline-block;
    width: 200px;
  }
  .container-style {
    text-align: left;
    display: inline-block;
  }
  .input-style {
    background: #ecf0f1;
    border: none;
    border-radius: 5px;
    outline: none;
  }
  .select-style {
    background: #ecf0f1;
    border: none;
    border-radius: 5px;
    outline: none;
  }
  .text-style {
    font-size: 20px;
    font-family: Arial Black;
    color: #2c3e50;
    padding: 5px;
    margin: 5px;
  }
</style>

<script>
  const validateMovingAveragePeriod = movingAveragePeriod =>
    Math.max(Math.min(movingAveragePeriod, 360), 1);
</script>

<script>
  class Store {
    constructor() {
      this.state = {
        days: 360,
        cryptocurrencyId: 'bitcoin',
        vsCurrencyId: 'usd',
        priceHistory: [],
        movingAveragePeriod: 30,
        isLoading: true,
      };

      // Bind actions to reducers
      window.addEventListener('SET_PRICE_HISTORY', ({ detail }) => {
        this.state = this.onSetPriceHistory(this.state, detail);
        this.render(this.state);
      });
      window.addEventListener('SET_CRYPTOCURRENCY', ({ detail }) => {
        this.state = this.onSetCryptocurrency(this.state, detail);
        this.fetchPriceHistory(this.state);
        this.render(this.state);
      });
      window.addEventListener('SET_VS_CURRENCY', ({ detail }) => {
        this.state = this.onSetVsCurrency(this.state, detail);
        this.fetchPriceHistory(this.state);
        this.render(this.state);
      });
      window.addEventListener('SET_MOVING_AVERAGE_PERIOD', ({ detail }) => {
        this.state = this.onSetMovingAveragePeriod(this.state, detail);
        this.render(this.state);
      });
      this.fetchPriceHistory(this.state);
    }

    // Reducers
    onSetPriceHistory(previousState, detail) {
      return detail.priceHistory
        ? {
            ...previousState,
            priceHistory: detail.priceHistory,
            isLoading: false,
          }
        : previousState;
    }
    onSetCryptocurrency(previousState, detail) {
      return detail.cryptocurrencyId
        ? {
            ...previousState,
            cryptocurrencyId: detail.cryptocurrencyId,
            isLoading: true,
          }
        : previousState;
    }
    onSetVsCurrency(previousState, detail) {
      return detail.vsCurrencyId.slice(-90)
        ? {
            ...previousState,
            vsCurrencyId: detail.vsCurrencyId,
            isLoading: true,
          }
        : previousState;
    }
    onSetMovingAveragePeriod(previousState, detail) {
      return detail.movingAveragePeriod
        ? {
            ...previousState,
            movingAveragePeriod: detail.movingAveragePeriod,
          }
        : previousState;
    }

    // Side effects (which can be called by epics)
    async fetchPriceHistory(state) {
      return fetch(
        `https://api.coingecko.com/api/v3/coins/${state.cryptocurrencyId}/market_chart?vs_currency=${state.vsCurrencyId}&days=${state.days}`
      )
        .then(res =>
          res.json().then(res => {
            const priceHistory = res.prices;
            window.dispatchEvent(
              new CustomEvent('SET_PRICE_HISTORY', { detail: { priceHistory } })
            );
          })
        )
        .catch(error => {
          console.log('error: ', error);
        });
    }

    render(state) {
      const { priceHistory } = state;
      const currentPrice = priceHistory.slice(-1)[0][1];

      if (state.isLoading) {
        document.getElementById('current-price').innerHTML = `
          <div class="lds-ellipsis">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>`;
        document.getElementById('current-moving-average').innerHTML = `
          <div class="lds-ellipsis">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>`;
      } else {
        // Render current price
        document.getElementById('current-price').innerHTML = currentPrice;

        // Render moving average label
        const movingAveragePeriod = validateMovingAveragePeriod(
          state.movingAveragePeriod
        );
        document.getElementById(
          'current-moving-average-label'
        ).innerHTML = `${movingAveragePeriod}-day moving average:`;

        // Render moving average
        const movingAverage =
          priceHistory
            .slice(-movingAveragePeriod)
            .reduce((sum, [timestamp, price]) => price + sum, 0) /
          movingAveragePeriod;
        document.getElementById(
          'current-moving-average'
        ).innerHTML = movingAverage;
      }
    }
  }
</script>

<div class="root-style">
  <span id="widget-container" class="container-style">
    <span class="text-style column-style">Cryptocurrency</span>
    <select
      id="cryptocurrency-select"
      class="text-style column-style select-style"
      style="width:200px;"
    >
      <option value="bitcoin">Bitcoin</option>
      <option value="ethereum">Ethereum</option>
      <option value="ripple">XRP</option>
      <option value="tether">Tether</option>
      <option value="bitcoin-cash">Bitcoin Cash</option>
      <!--TODO: Add the rest of the currencies from here: https://api.coingecko.com/api/v3/coins--> </select
    ><br />
    <span class="text-style column-style">vs. currency</span>
    <select
      id="vs-currency-select"
      class="text-style column-style select-style"
    >
      <option value="usd">United States dollar</option>
      <option value="eur">Euro</option>
      <option value="jpy">Japanese yen</option>
      <option value="gbp">Pound sterling</option>
      <!--TODO: Add the rest of the currencies from here: https://api.coingecko.com/api/v3/coins-->
    </select>
    <br />
    <span class="text-style column-style">Moving average period: </span>
    <input
      id="moving-average-period-input"
      class="input-style text-style column-style"
      type="number"
      value="30"
      style="width:200px;"
    />
    <br />
    <span class="text-style column-style">Current price: </span>
    <span id="current-price" class="text-style column-style"
      ><div class="lds-ellipsis">
        <div></div>
        <div></div>
        <div></div>
        <div></div></div
    ></span>
    <br />
    <span id="current-moving-average-label" class="text-style column-style"
      >30-day moving average:
    </span>
    <span id="current-moving-average" class="text-style column-style"
      ><div class="lds-ellipsis">
        <div></div>
        <div></div>
        <div></div>
        <div></div></div
    ></span>
  </span>
</div>

<!--Add change listeners to HTML-->
<script>
  const cryptocurrencySelect = document.getElementById('cryptocurrency-select');
  cryptocurrencySelect.addEventListener('change', () => {
    const cryptocurrencyId = cryptocurrencySelect.value;
    window.dispatchEvent(
      new CustomEvent('SET_CRYPTOCURRENCY', { detail: { cryptocurrencyId } })
    );
  });

  const vsCurrencySelect = document.getElementById('vs-currency-select');
  vsCurrencySelect.addEventListener('change', () => {
    const vsCurrencyId = vsCurrencySelect.value;
    window.dispatchEvent(
      new CustomEvent('SET_VS_CURRENCY', { detail: { vsCurrencyId } })
    );
  });

  const movingAveragePeriodInput = document.getElementById(
    'moving-average-period-input'
  );
  movingAveragePeriodInput.addEventListener('input', () => {
    const movingAveragePeriod = movingAveragePeriodInput.value;
    window.dispatchEvent(
      new CustomEvent('SET_MOVING_AVERAGE_PERIOD', {
        detail: { movingAveragePeriod },
      })
    );
  });
</script>
<script>
  const store = new Store();
</script>
