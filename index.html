<script>
  class Store {
    constructor() {
      this.state = {
        days: 90,
        cryptocurrencyId: 'bitcoin',
        vsCurrencyId: 'usd',
        priceHistory: [],
        movingAveragePeriod: 30,
      };

      // Bind actions to reducers
      window.addEventListener('SET_PRICE_HISTORY', ({ detail }) => {
        this.state = this.onSetPriceHistory(this.state, detail);
        this.render();
      });
      window.addEventListener('SET_CRYPTOCURRENCY', ({ detail }) => {
        this.state = this.onSetCryptocurrency(this.state, detail);
        this.afterSetCryptocurrency(this.state);
      });
      window.addEventListener('SET_VS_CURRENCY', ({ detail }) => {
        this.state = this.onSetVsCurrency(this.state, detail);
        this.afterSetVsCurrency(this.state);
      });
      window.addEventListener('SET_MOVING_AVERAGE_PERIOD', ({ detail }) => {
        this.state = this.onSetMovingAveragePeriod(this.state, detail);
        this.afterSetMovingAveragePeriod(this.state);
      });
      this.fetchPriceHistory(this.state);
    }

    // Reducers
    onSetPriceHistory(previousState, detail) {
      return detail.priceHistory
        ? { ...previousState, priceHistory: detail.priceHistory }
        : previousState;
    }
    onSetCryptocurrency(previousState, detail) {
      return detail.cryptocurrencyId
        ? { ...previousState, cryptocurrencyId: detail.cryptocurrencyId }
        : previousState;
    }
    onSetVsCurrency(previousState, detail) {
      return detail.vsCurrencyId.slice(-90)
        ? { ...previousState, vsCurrencyId: detail.vsCurrencyId }
        : previousState;
    }
    onSetMovingAveragePeriod(previousState, detail) {
      return detail.movingAveragePeriod
        ? {
            ...previousState,
            movingAveragePeriod: detail.movingAveragePeriod,
          }
        : previousState;
    }

    // Side effects (which can be called by epics)
    async fetchPriceHistory(state) {
      return fetch(
        `https://api.coingecko.com/api/v3/coins/${
          state.cryptocurrencyId
        }/market_chart?vs_currency=${
          state.vsCurrencyId
        }&days=${state.movingAveragePeriod + 90}`
      )
        .then(res =>
          res.json().then(res => {
            const priceHistory = res.prices;
            window.dispatchEvent(
              new CustomEvent('SET_PRICE_HISTORY', { detail: { priceHistory } })
            );
          })
        )
        .catch(error => {
          console.log('error: ', error);
        });
    }

    // Epics
    afterSetCryptocurrency(state) {
      this.fetchPriceHistory(state);
    }

    afterSetVsCurrency(state) {
      this.fetchPriceHistory(state);
    }

    afterSetMovingAveragePeriod(state) {
      if (state.priceHistory.length < 90 + state.movingAveragePeriod) {
        this.fetchPriceHistory(state);
      }
    }

    render() {
      // Render current price
      console.log('this.state.priceHistory: ', this.state.priceHistory);
      document.getElementById(
        'current-price'
      ).innerHTML = this.state.priceHistory[
        this.state.priceHistory.length - 1
      ][1];

      // Render price chart
      const maxPrice = this.state.priceHistory
        .slice(-90)
        .reduce((maxPrice, [timeStamp, price]) => Math.max(maxPrice, price), 0);
      const priceHistory = this.state.priceHistory.slice(-90);
      priceHistory.forEach(([timeStamp, price], index) => {
        const priceBar = document.getElementById(`price-bar-${index}`);
        priceBar.style.height = `calc(50vh * ${price} / ${maxPrice})`;
      });

      // Render moving average chart
      const { movingAveragePeriod } = this.state;
      const movingAverage = this.state.priceHistory
        .map(([timeStamp, price], index) => {
          const pricesToAverage = this.state.priceHistory.slice(
            Math.max(0, index - movingAveragePeriod) + 1,
            index + 1
          );
          const averagePrice =
            pricesToAverage.reduce(
              (sum, [timestamp, price]) => price + sum,
              0
            ) / movingAveragePeriod;
          return [timeStamp, averagePrice];
        })
        .slice(-90);
      console.log('movingAverage: ', movingAverage);
      movingAverage.forEach(([timeStamp, price], index) => {
        const movingAverageBar = document.getElementById(
          `moving-average-bar-${index}`
        );
        movingAverageBar.style.height = `calc(50vh * ${price} / ${maxPrice})`;
      });
    }
  }
</script>

<body style="background:DarkSlateGrey;">
  <div id="app-container">
    <span style="display:inline-block;width:100px;">Cryptocurrency</span>
    <select id="cryptocurrency-select">
      <option value="bitcoin">Bitcoin</option>
      <option value="ethereum">Ethereum</option>
      <option value="ripple">XRP</option>
      <option value="tether">Tether</option>
      <option value="bitcoin-cash">Bitcoin Cash</option>
      <!--TODO: Add the rest of the currencies from here: https://api.coingecko.com/api/v3/coins--> </select
    ><br />
    <span style="display:inline-block;width:100px;">vs. currency</span>
    <select id="vs-currency-select">
      <option value="usd">United States dollar</option>
      <option value="eur">Euro</option>
      <option value="jpy">Japanese yen</option>
      <option value="gbp">Pound sterling</option>
      <!--TODO: Add the rest of the currencies from here: https://api.coingecko.com/api/v3/coins--> </select
    ><br />
    <span style="display:inline-block;width:100px;">Current price: </span>
    <span id="current-price"></span>
    <br />
    <span style="display:inline-block;width:100px;"
      >Moving average period:
    </span>
    <input id="moving-average-period-input" type="number" value="30" />
    <div id="chart-container" style="width:100vw;height:50vh;"></div>
  </div>
</body>

<!--Initialize chart bars-->
<script>
  const chartContainer = document.getElementById('chart-container');
  for (let i = 0; i < 90; i++) {
    const bar = document.createElement('span');
    bar.id = `bar-${i}`;
    bar.style.cssText = `
      display: inline-block;
      width: calc(100vw/${90});
      position: relative;
      height: 50vh;
    `;

    const priceBar = document.createElement('span');
    priceBar.id = `price-bar-${i}`;
    priceBar.style.cssText = `
      display: inline-block;
      width: calc(100vw/${90});
      position: absolute;
      bottom: 0;
      background-image: linear-gradient(rgb(255, 255, 255, 0.5), rgba(255, 255, 255, 0));
      height: 0;
      transition: 0.5s;
    `;
    bar.appendChild(priceBar);

    const movingAverageBar = document.createElement('span');
    movingAverageBar.id = `moving-average-bar-${i}`;
    movingAverageBar.style.cssText = `
      display: inline-block;
      width: calc(100vw/${90});
      position: absolute;
      bottom: 0;
      border-top: 2px solid cyan;
      height: 0;
      transition: 0.5s;
    `;
    bar.appendChild(movingAverageBar);

    chartContainer.appendChild(bar);
  }
</script>

<!--Add change listeners to HTML-->
<script>
  const cryptocurrencySelect = document.getElementById('cryptocurrency-select');
  cryptocurrencySelect.addEventListener('change', () => {
    const cryptocurrencyId = cryptocurrencySelect.value;
    window.dispatchEvent(
      new CustomEvent('SET_CRYPTOCURRENCY', { detail: { cryptocurrencyId } })
    );
  });

  const vsCurrencySelect = document.getElementById('vs-currency-select');
  vsCurrencySelect.addEventListener('change', () => {
    const vsCurrencyId = vsCurrencySelect.value;
    window.dispatchEvent(
      new CustomEvent('SET_VS_CURRENCY', { detail: { vsCurrencyId } })
    );
  });

  const movingAveragePeriodInput = document.getElementById(
    'moving-average-period-input'
  );
  movingAveragePeriodInput.addEventListener('input', () => {
    const movingAveragePeriod = movingAveragePeriodInput.value;
    window.dispatchEvent(
      new CustomEvent('SET_MOVING_AVERAGE_PERIOD', {
        detail: { movingAveragePeriod },
      })
    );
  });
</script>
<script>
  const store = new Store();
</script>
